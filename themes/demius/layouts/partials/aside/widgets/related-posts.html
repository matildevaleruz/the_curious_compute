<!-- related-posts.html -->
{{ if and (.Site.Params.aside.showRelatedPosts | default true) (eq .Kind "page") (eq .Type "posts") }}
  {{ $relatedCount := .Site.Params.aside.relatedCount | default 5 }}
  {{ $related := .Site.RegularPages.Related . | first $relatedCount }}
  
  {{ $relatedConfig := index .Site.Params.aside "related-Posts" }}
  {{ $enableBg := $relatedConfig.enableBackground | default false }}
  {{ $bgImage := $relatedConfig.backgroundImage }}
  {{ $bgColor := $relatedConfig.backgroundColor }}
  {{ $bgSize := $relatedConfig.backgroundSize | default "cover" }}
  {{ $bgPosition := $relatedConfig.backgroundPosition | default "center" }}
  {{ $bgRepeat := $relatedConfig.backgroundRepeat | default "no-repeat" }}
  {{ $textColor := $relatedConfig.textColor }}
  {{ $textShadow := $relatedConfig.textShadow | default false }}
  {{ $overlayColor := $relatedConfig.overlayColor }}
  {{ $borderRadius := $relatedConfig.borderRadius }}
  
  <section class="aside-card related-posts-card{{ if $enableBg }} related-posts-card-with-bg{{ end }}"
    {{ if $enableBg }}
    {{ $styleStr := "" }}
    {{ if $bgImage }}
      {{ $styleStr = printf "background-image: url('%s');" $bgImage }}
    {{ else if $bgColor }}
      {{ $styleStr = printf "background: %s;" $bgColor }}
    {{ end }}
    {{ if or $bgImage $bgColor }}
      {{ $styleStr = printf "%s background-size: %s; background-position: %s; background-repeat: %s;" $styleStr $bgSize $bgPosition $bgRepeat }}
    {{ end }}
    {{ if $borderRadius }}
      {{ $styleStr = printf "%s border-radius: %s;" $styleStr $borderRadius }}
    {{ end }}
    style="{{ $styleStr | safeCSS }}"
    {{ end }}
  >
    {{ if and $enableBg $overlayColor }}
    <div class="related-posts-card-overlay" style="background: {{ $overlayColor }};"></div>
    {{ end }}
    
    <div class="related-posts-card-content"
      {{ if and $enableBg $textColor }}
      style="
        color: {{ $textColor }};
        {{ if $textShadow }}text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);{{ end }}
      "
      {{ end }}
    >
      <h3 class="aside-title"><i class="fas fa-link"></i> 相关文章</h3>
      <div class="related-posts">
      {{ if $related }}
        {{ range $related }}
          {{ $defaultCover := $.Site.Params.images.defaultCover | default "/img/default-cover.jpg" }}
          {{ $fallbackImage := $.Site.Params.images.fallbackImage | default "/img/404.jpg" }}
          {{ $cover := .Params.cover | default $defaultCover }}
          <a class="related-item" href="{{ .RelPermalink }}">
            <div class="related-thumb">
              <img src="{{ $cover | relURL }}" 
                   alt="{{ .Title }}" 
                   loading="lazy"
                   onerror="this.onerror=null; this.src='{{ $fallbackImage | relURL }}'">
            </div>
            <div class="related-meta">
              <div class="related-title">{{ .Title }}</div>
              <div class="related-date">{{ .Date.Format "2006-01-02" }}</div>
            </div>
          </a>
        {{ end }}
      {{ else }}
        <div class="aside-empty">
          {{ if or .Params.tags .Params.categories }}
            暂无相关文章
          {{ else }}
            为文章添加标签或分类以显示相关推荐
          {{ end }}
        </div>
      {{ end }}
    </div>
    </div>
  </section>
{{ end }}